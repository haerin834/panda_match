{% extends 'base.html' %}

{% block title %}Panda Match - Level {{ session.level.level_id }}{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12 text-center">
        <h1>Level {{ session.level.level_id }}</h1>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="score-display">
            Score: <span id="score-value">{{ session.score }}</span>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8 mx-auto">
        <!-- Game board area -->
        <div class="game-board-container">
            <div class="game-board" id="game-board">
                <!-- Game tiles will be loaded dynamically via JavaScript -->
            </div>
        </div>
        
        <!-- Fence/Buffer zone -->
        <div class="fence-container mt-4">
            <div class="fence-background">
                <div class="buffer-zone" id="buffer-zone">
                    <!-- Buffer tiles will appear here -->
                </div>
            </div>
        </div>
        
        <!-- Removed tiles area -->
        <div class="removed-tiles-container mt-2" id="removed-tiles-container">
            <!-- Removed tiles will appear here -->
        </div>
        
        <!-- Game control buttons -->
        <div class="control-buttons mt-4">
            <button id="btn-remove" class="btn btn-primary tool-button">
                <i class="fas fa-arrow-up"></i>
                <span>移出道具</span>
            </button>
            <button id="btn-withdraw" class="btn btn-warning tool-button mx-3">
                <i class="fas fa-undo"></i>
                <span>撤回道具</span>
            </button>
            <button id="btn-shuffle" class="btn btn-info tool-button">
                <i class="fas fa-random"></i>
                <span>洗牌道具</span>
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12 text-center">
        <a href="{% url 'abandon_game' session.session_id %}" class="btn btn-danger">
            <i class="fas fa-times me-1"></i> 退出游戏
        </a>
    </div>
</div>

<!-- Game Over Modal -->
<div class="modal fade" id="gameOverModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">关卡完成！</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <h3>恭喜！</h3>
                <p>您已完成此关卡，得分为 <span id="final-score">{{ session.score }}</span>！</p>
            </div>
            <div class="modal-footer">
                <a href="{% url 'game_result' session.session_id %}" class="btn btn-primary">查看结果</a>
            </div>
        </div>
    </div>
</div>

<!-- Tool Info Modals -->
<div class="modal fade" id="removeToolModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">移出道具</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <img src="https://via.placeholder.com/100" alt="移出道具" class="rounded-circle bg-dark">
                </div>
                <p>移出三张牌并把他们堆放到旁边（后面还可以通过点击，转移回栅栏）。</p>
                <button id="use-remove-tool" class="btn btn-primary">获取(1/1)</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">不，谢谢</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="withdrawToolModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">撤回道具</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <img src="https://via.placeholder.com/100" alt="撤回道具" class="rounded-circle bg-dark">
                </div>
                <p>撤回最近的一张牌并把他放到原位置。</p>
                <button id="use-withdraw-tool" class="btn btn-primary">获取(1/1)</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">不，谢谢</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="shuffleToolModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">洗牌道具</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <img src="https://via.placeholder.com/100" alt="洗牌道具" class="rounded-circle bg-dark">
                </div>
                <p>随机打乱未使用的所有牌。</p>
                <button id="use-shuffle-tool" class="btn btn-primary">获取(1/1)</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">不，谢谢</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .game-board-container {
        position: relative;
        width: 100%;
        height: 500px;
        margin: 0 auto;
        background-color: #c8e6c9;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .game-board {
        position: relative;
        width: 100%;
        height: 100%;
    }
    
    .game-tile {
        position: absolute;
        width: 60px;
        height: 60px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background-color: #ffffff;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.7);
        transition: transform 0.2s;
        text-align: center;
        font-size: 24px;
    }
    
    .game-tile:hover {
        transform: scale(1.05);
        z-index: 100;
    }
    
    .game-tile.selected {
        border-color: #ffeb3b;
        transform: scale(1.1);
        z-index: 100;
    }
    
    .fence-container {
        position: relative;
        width: 100%;
        height: 80px;
    }
    
    .fence-background {
        background-color: #8d6e63;
        height: 100%;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .buffer-zone {
        display: flex;
        gap: 8px;
        padding: 10px;
        width: 95%;
        height: 65px;
        align-items: center;
    }
    
    .buffer-zone .game-tile {
        position: relative;
        width: 50px;
        height: 50px;
        border-radius: 6px;
        font-size: 20px;
    }
    
    .removed-tiles-container {
        min-height: 60px;
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        padding: 10px;
        display: flex;
        gap: 8px;
    }
    
    .removed-tiles-container .game-tile {
        position: relative;
        width: 50px;
        height: 50px;
        border-radius: 6px;
        font-size: 20px;
    }
    
    .control-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
    }
    
    .tool-button {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px 15px;
        border-radius: 8px;
    }
    
    .tool-button i {
        font-size: 20px;
        margin-bottom: 5px;
    }
    
    /* Tile type specific styles */
    .tile-bamboo { background-color: #91c788; }
    .tile-leaf { background-color: #86c6f4; }
    .tile-panda { background-color: #b5a7c9; }
    .tile-fish { background-color: #f6ae99; }
    .tile-carrot { background-color: #ffcd85; }
    .tile-fire { background-color: #ff9b93; }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Game data
    const sessionId = {{ session.session_id }};
    let boardData = {{ board|safe }};
    let accessibleTiles = {{ accessible_tiles|safe }};
    let bufferData = []; // Start with empty buffer
    let removedTiles = []; // Storage for removed tiles
    
    // Game elements
    const gameBoard = document.getElementById('game-board');
    const bufferZone = document.getElementById('buffer-zone');
    const removedTilesContainer = document.getElementById('removed-tiles-container');
    const scoreValue = document.getElementById('score-value');
    
    // Tool buttons
    const btnRemove = document.getElementById('btn-remove');
    const btnWithdraw = document.getElementById('btn-withdraw');
    const btnShuffle = document.getElementById('btn-shuffle');
    
    // Modals
    const gameOverModal = new bootstrap.Modal(document.getElementById('gameOverModal'));
    const removeToolModal = new bootstrap.Modal(document.getElementById('removeToolModal'));
    const withdrawToolModal = new bootstrap.Modal(document.getElementById('withdrawToolModal'));
    const shuffleToolModal = new bootstrap.Modal(document.getElementById('shuffleToolModal'));
    
    // CSRF token for AJAX requests
    const csrfToken = '{{ csrf_token }}';
    
    // Initialize the game board
    function initializeBoard() {
        // Clear the board
        gameBoard.innerHTML = '';
        
        // Add tiles to the board
        for (const key in accessibleTiles) {
            const tile = accessibleTiles[key];
            createTileElement(tile, gameBoard);
        }
    }
    
    // Update the buffer zone
    function updateBuffer() {
        console.log("updateBuffer called with bufferData:", bufferData);
        
        // 清空栅栏
        bufferZone.innerHTML = '';
        
        // 将所有方块添加到栅栏
        for (const tile of bufferData) {
            const tileElement = createTileElement(tile, bufferZone);
            // 在栅栏区域中，方块不需要有特定位置，只需要排成一行
        }
    }
    
    // Update the removed tiles area
    function updateRemovedTiles() {
        // Clear the removed tiles
        removedTilesContainer.innerHTML = '';
        
        // Add removed tiles to the container
        for (const tile of removedTiles) {
            const tileElement = createTileElement(tile, removedTilesContainer);
            
            // Add click handler to return tile to buffer
            tileElement.addEventListener('click', () => {
                // TODO: Implement returning removed tiles to buffer
                alert('功能尚未实现: 将移除的牌返回栅栏');
            });
        }
    }
    
    // Create a tile element
    function createTileElement(tile, container) {
        const tileElement = document.createElement('div');
        tileElement.classList.add('game-tile', `tile-${tile.type}`);
        tileElement.dataset.tileId = tile.id;
        tileElement.dataset.tileType = tile.type;
        
        // Add icon based on tile type
        let icon = '';
        switch (tile.type) {
            case 'bamboo':
                icon = '<i class="fas fa-seedling"></i>';
                break;
            case 'leaf':
                icon = '<i class="fas fa-leaf"></i>';
                break;
            case 'panda':
                icon = '<i class="fas fa-paw"></i>';
                break;
            case 'fish':
                icon = '<i class="fas fa-fish"></i>';
                break;
            case 'carrot':
                icon = '<i class="fas fa-carrot"></i>';
                break;
            case 'fire':
                icon = '<i class="fas fa-fire"></i>';
                break;
        }
        
        tileElement.innerHTML = icon;
        
        // If this is a board tile, position it
        if (container === gameBoard && tile.x !== undefined && tile.y !== undefined) {
            // Calculate position with slight offset for layers
            const offsetX = tile.layer * 2;
            const offsetY = tile.layer * 2;
            
            tileElement.style.left = `${tile.x * 60 + offsetX}px`;
            tileElement.style.top = `${tile.y * 60 + offsetY}px`;
            tileElement.style.zIndex = tile.layer;
            
            // Add click handler for board tiles
            tileElement.addEventListener('click', () => selectTile(tile.id));
        }
        
        // Add the tile to the container
        container.appendChild(tileElement);
        
        return tileElement;
    }
    
    // Select a tile
    function selectTile(tileId) {
        // If buffer is full (7 slots), do nothing
        if (bufferData.length >= 7) {
            alert('栅栏已满，无法添加更多方块');
            return;
        }
        
        // Send AJAX request to select the tile
        fetch(`/game/action/${sessionId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                action: 'select_tile',
                tile_id: tileId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 更新栅栏数据
                bufferData = data.buffer;

                console.log("Buffer data after update:", bufferData);

                updateBuffer();
                
                // 更新分数
                scoreValue.textContent = data.score;
                
                // 更新可访问的方块
                accessibleTiles = data.accessible_tiles;
                initializeBoard();
                
                // 检查游戏是否结束
                if (data.game_over) {
                    document.getElementById('final-score').textContent = data.score;
                    setTimeout(() => {
                        gameOverModal.show();
                    }, 1000);
                }
            }
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Use remove tool
    function useRemoveTool() {
        // If buffer has less than 3 tiles, do nothing
        if (bufferData.length < 3) {
            alert('栅栏中至少需要3个方块才能使用此道具');
            return;
        }
        
        // Send AJAX request to use the tool
        fetch(`/game/action/${sessionId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                action: 'use_remove_tool'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update buffer data
                bufferData = data.buffer;
                updateBuffer();
                
                // Update removed tiles
                removedTiles = data.removed_tiles;
                updateRemovedTiles();
            }
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Use withdraw tool
    function useWithdrawTool() {
        // If buffer is empty, do nothing
        if (bufferData.length === 0) {
            alert('栅栏中没有方块，无法使用此道具');
            return;
        }
        
        // Send AJAX request to use the tool
        fetch(`/game/action/${sessionId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                action: 'use_withdraw_tool'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update buffer data
                bufferData = data.buffer;
                updateBuffer();
                
                // Update accessible tiles
                accessibleTiles = data.accessible_tiles;
                initializeBoard();
            }
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Use shuffle tool
    function useShuffleTool() {
        // Send AJAX request to use the tool
        fetch(`/game/action/${sessionId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                action: 'use_shuffle_tool'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update accessible tiles
                accessibleTiles = data.accessible_tiles;
                initializeBoard();
            }
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Tool button event listeners
    btnRemove.addEventListener('click', () => {
        removeToolModal.show();
    });
    
    btnWithdraw.addEventListener('click', () => {
        withdrawToolModal.show();
    });
    
    btnShuffle.addEventListener('click', () => {
        shuffleToolModal.show();
    });
    
    // Tool use event listeners
    document.getElementById('use-remove-tool').addEventListener('click', () => {
        useRemoveTool();
        removeToolModal.hide();
    });
    
    document.getElementById('use-withdraw-tool').addEventListener('click', () => {
        useWithdrawTool();
        withdrawToolModal.hide();
    });
    
    document.getElementById('use-shuffle-tool').addEventListener('click', () => {
        useShuffleTool();
        shuffleToolModal.hide();
    });
    
    // Initialize the game when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        initializeBoard();
        updateBuffer();
        updateRemovedTiles();
    });
</script>
{% endblock %}